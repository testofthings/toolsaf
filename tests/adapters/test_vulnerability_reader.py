import pytest
from pathlib import Path
from unittest.mock import MagicMock

from tdsaf.adapters.vulnerability_reader import VulnerabilityReader
from tdsaf.core.components import Software
from tdsaf.common.property import PropertyKey
from tdsaf.common.verdict import Verdict
from tests.test_model import Setup


@pytest.mark.parametrize(
    "spec, exp",
    [(Software, True), (Setup, False)]
)
def test_filter_component(spec, exp):
    reader = VulnerabilityReader(Setup().get_system())
    mock = MagicMock(spec=spec)
    assert reader.filter_component(mock) == exp


def test_process_component():
    setup = Setup()
    reader = VulnerabilityReader(setup.get_system())

    device = setup.system.device("Device")
    software = device.software().sw

    with Path("tests/samples/vulnerabilities/device.csv").open("rb") as f:
        reader.process_component(software, f, setup.get_inspector(), MagicMock())

        assert len(software.properties) == 3
        assert software.properties[PropertyKey("vulnz", "test1", "cve-1")].verdict == Verdict.FAIL
        assert software.properties[PropertyKey("vulnz", "test2", "cve-2")].verdict == Verdict.FAIL